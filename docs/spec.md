# 画像整理アプリ 仕様（実装順：取り込み＆ブラウズ → AI機能）

## 0. 目的と前提
- 目的：画像を「取り込み」「閲覧（ブラウズ）」「フォルダ／タグで整理」できるiOSアプリを作る
- 実装方針：まずはAIなしで使える“画像管理の核”を完成させ、その後にAI機能を段階的に追加する
- プラットフォーム：iOS
- 想定実装：Swift / SwiftUI（ただし詳細は後で変更可能）

---

## 1. フェーズ1：画像の取り込みとブラウズ（AIなしで成立させる）

### 1.1 取り込みソース
- Photos（写真アプリ）
- Files（ファイルアプリ／iCloud Drive等）

### 1.2 取り込み方式
- 取り込み時に以下を行う
  - 画像のユニークIDを付与（内部ID）
  - サムネイル生成（複数サイズが望ましいが、最初は1サイズでも可）
  - オリジナル画像の保存方針を選べるようにする（初期は一択でもOK）
    - 例：アプリ内にコピーして管理／参照のみ（後で決める）
- 取り込み後、ライブラリに即時反映される

### 1.3 メタデータ（AIではないが重要）
- 取り込み時に可能な範囲で読み取る（初期は最低限でも可）
  - EXIF：撮影日時、サイズ、向き（orientation）
  - 可能なら：位置情報（GPS）、カメラ機種
  - 可能なら：IPTC/XMPのキーワード（既存タグがあれば取り込む）
- 読めたメタデータはDBに保存し、検索／並び替えに利用できるようにする

### 1.4 ライブラリ（ブラウズ）
- 基本画面：グリッド表示（サムネイル）
- 詳細画面：1枚表示＋メタ情報＋タグ表示
- 最低限の操作
  - スクロール
  - 並び替え（例：新しい順／古い順）
  - 絞り込み（最初は「タグで絞り込み」なしでも可）
  - 削除（アプリ内管理の画像のみ。Photos側を消すかは後で検討）

### 1.5 フォルダ／アルバム（フェーズ1の範囲）
- 最初は「アルバム（仮想フォルダ）」として実装するのが安全
  - アルバムの作成／名称変更／削除
  - 画像をアルバムに追加／除外
- 画像は複数アルバムに所属できる（後で変更可）

### 1.6 タグ（フェーズ1の範囲）
- ユーザーが手動でタグを付けられる
  - 追加／削除
  - 複数タグ付け
- タグの表記ゆれ対策は後回し（将来的に正規化を検討）
- タグは「画像に紐づくメタ情報」としてDBに保存する

### 1.7 検索（フェーズ1の範囲）
- 最初の検索は軽くてよい（段階的に強化）
  - タグ検索（完全一致で開始）
  - メタ情報検索（撮影日など）※後回しでも可

### 1.8 ローカルデータ管理（最小要件）
- DB（例：Core Data / SQLiteのいずれか）
  - images：画像ID、保存先参照、撮影日時、サイズ、向き、その他メタ
  - tags：タグ辞書（名称、作成日時など）
  - image_tags：画像とタグの中間テーブル
  - albums：アルバム（名称、作成日時）
  - album_images：アルバムと画像の中間テーブル
- キャッシュ
  - サムネイルをディスクキャッシュして高速化
- バックアップ／同期はフェーズ1では必須にしない（後で検討）

### 1.9 非機能要件（フェーズ1）
- 取り込み後の表示が遅くならない（サムネ生成は可能なら非同期）
- 大量画像で落ちにくい（メモリに載せすぎない）
- 権限が無い場合の表示／導線（Photosアクセス許可など）を用意

---

## 2. フェーズ2：AIモデルを利用した機能（段階追加）

### 2.1 AI導入の基本方針
- “AIが勝手に確定する” ではなく “おすすめ（提案）” として扱う
- タグには「由来」を持たせる（内部属性でOK）
  - 例：ユーザー確定／メタデータ由来／AI提案
- AI提案はいつでも一括削除できる（UX上重要）

### 2.2 機能A：類似画像検索（embedding）
- 画像から特徴量（embedding）を生成してDBに保存
- 類似検索インデックス（簡易でも可）を構築し、以下を提供
  - 「似ている画像」を表示
  - 「似ている画像のタグ」をおすすめ候補として提示
- UI要件
  - おすすめタグの表示
  - ワンタップで採用／却下
  - 「おすすめタグのみ非表示」などの操作ができると望ましい

### 2.3 機能B：OCR（書名／著者などの読み取り）
- 表紙画像などからテキストを抽出し、DBに保存
- 抽出テキストを「検索対象」に含める
- 書名／著者の推定は段階導入
  - まずは「文字列抽出のみ」
  - 次に「書名っぽい」「著者名っぽい」推定（軽量ルール／軽量NLP）
- UI要件
  - OCR結果の確認画面（誤り修正できると望ましい）
  - 確定結果はユーザー編集が優先される

### 2.4 機能C：自動カテゴリ分け（任意）
- 例：「人物」「風景」「食べ物」「スクショ」など粗い分類
- フェーズ1の体験を壊さない形で追加（フィルタやスマートアルバムとして提供）

### 2.5 モデル配布・実行（将来の選択肢）
- オンデバイス推論を基本とする
- モデルが大きくなった場合
  - アプリ同梱ではなく、後からダウンロードする方式を検討（ODR等）
- 精度やコスト要件次第で、任意のサーバ処理（ハイブリッド）も将来選択肢として残す

### 2.6 非機能要件（フェーズ2）
- 推論はUIをブロックしない（バックグラウンドで処理し進捗表示）
- バッテリー・発熱に配慮（連続推論の制限やスケジューリング）
- 提案の透明性（「AI提案」と明示し、確定はユーザー操作で行う）

---

## 3. 画面（最小セット）
### フェーズ1
- 取り込み（Photos / Files）
- ライブラリ（グリッド）
- 詳細（1枚表示＋タグ編集）
- アルバム管理（一覧＋作成＋追加）

### フェーズ2
- 似ている画像（詳細画面のサブビューでも可）
- おすすめタグ（採用／却下）
- OCR結果表示（確認・編集）

---

## 4. 仕様の決め残し（後で詰める項目）
- オリジナル画像の保存方針（コピー管理／参照管理）
- iCloud同期の有無（タグ・アルバム・インデックス）
- タグの正規化（同義語、表記ゆれ、階層タグなど）
- OCR対象言語（日本語・英語など）と精度要件
- AIモデルの選定とサイズ（配布方法含む）
- 課金の有無（AI機能を有料プランにするか等）

---